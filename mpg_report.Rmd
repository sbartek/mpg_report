---
title: "Report on Fuel Consumption of automobiles"
date: "May 13th, 2015"
output: rmarkdown::tufte_handout
---

```{r loads.libraries, echo=FALSE}
require('ggplot2')
require('data.table')
require('ggthemes')
require('leaps')
require('xtable')


cs.dt <- data.table(mtcars)
cs.dt$am <- as.factor(cs.dt$am)
cs.dt$cyl <- as.factor(cs.dt$cyl)
cs.dt$gear <- as.factor(cs.dt$gear)
cs.dt$vs <- as.factor(cs.dt$vs)
cs.dt$carb <- as.factor(cs.dt$carb)
```

# Introduction

We investigate data that extracted from the 1974 _Motor Trend_ US
magazine. They comprises fuel consumption and 10 aspects of automobile
design and performance for 32 automobiles (1973-74 models). We are
particularly interested in the following questions:

* Is an automatic or manual transmission better for MPG?
* Quantify the MPG difference between automatic and manual
  transmissions.


```{r boxplot1, fig.margin = TRUE, fig.cap = "Automatic vs. manual transmission."}

ggplot(cs.dt, aes(am, mpg)) + geom_boxplot() + theme_tufte() +
            scale_x_discrete(labels=c("manual", "automatic"))
```

```{r WTGimpact, fig.margin = TRUE, fig.cap = "Impact of weight, transmission and number of cylinders on fuel consumption."}

ggplot(cs.dt, aes(wt, mpg, colour=am)) + geom_point() + theme_tufte() +
    geom_text(aes(label=cyl, colour=NULL), vjust=-0.6) +
        geom_smooth(method='lm')
```

The boxplot on Figure 1 suggests that manual transmission is better
for mpg. However, Figure 2 shows that actually weight or number of
gears can be the most important factor.


# Model Selection

Let us try to identify the subset of the predictors that can be
related to the mpg response. For that we use `regsubsets` function
from `leaps` library which select the best model with \(n\) predictors,
for \(n=1 \ldots 8\). 

```{r selection, results='asis'}
regfit <- regsubsets(mpg~. ,cs.dt)
reg.summary <- summary(regfit)
print(xtable(reg.summary$outmat), size="\\tiny")
```

```{r r2statistic, fig.margin=TRUE, fig.cap="$R^2$ statistic for the best model with $n=1,\\ldots, 8$."} 
ggplot(data=NULL, aes(x=1:length(reg.summary$rsq), y=reg.summary$rsq)) +
    geom_line() + theme_bw() +
    labs(x='n', y="R2 statistic")
```

If we take a look at Figure 3 where we plot $R^2$ statistic for the
best model with $n=1,..., 8$ predictors, we see that $n=5$ would be
the best choice. Therefore our regression model is the following.

```{r 5predictors, results='asis'} 
fit <- lm(mpg~ hp + wt + am + I(cyl==6) + I(vs==1), data=cs.dt)
print(xtable(summary(fit)$coefficients))
```

```{r}
names(summary(regfit))
reg.summary$rsq
reg.summary$which


## plot(regfit.full ,scale ="r2")
## plot(regfit.full , scale ="adjr2") ## plot(regfit.full, scale ="Cp")

fit.full <- lm(mpg~., data=cs.dt)
summary(fit.full)
fit.wt <- lm(mpg~wt*am, data=cs.dt)
summary(fit.wt)
fit.hp <- lm(mpg~hp*am, data=cs.dt)
summary(fit.hp)
fit.wthp <- lm(mpg~(hp+wt)*am, data=cs.dt)
summary(fit.wthp)
summary(fit.full)$coef
```

```{r, fig.margin = TRUE, fig.cap = "Sepal length vs. petal length, colored by species"}

ggplot(cs.dt, aes(hp, mpg, colour=am)) +
    geom_point() +
        geom_text(aes(label=cyl, colour=NULL), vjust=-0.6) +
        theme_tufte() +
            geom_smooth(method='lm')

ggplot(cs.dt, aes(hp, wt, colour=am)) +
    geom_point() +
        geom_text(aes(label=cyl, colour=NULL), vjust=-0.6) +
        theme_tufte() +
            geom_smooth(method='lm')


ggplot(cs.dt, aes(disp, mpg, colour=am)) +
    geom_point() +
        theme_tufte() +
            geom_smooth(method='lm')

ggplot(cs.dt, aes(wt, disp, colour=am)) +
    geom_point() +
        theme_tufte() +
            geom_smooth(method='lm')


```




# Is an automatic or manual transmission better for MPG?

It seems so. 

```{r}
fit.wt <- lm(mpg ~ wt*am, data=cs.dt)
summary(fit.wt)
fit.hp <- lm(mpg ~ hp*am, data=cs.dt)
summary(fit.hp)
fit.hpwt <- lm(mpg ~ (hp+wt)*am, data=cs.dt)
summary(fit.hpwt)



fit2 <- lm(mpg ~ wt+hp, data=cs.dt)
summary(fit2)


fit1 <- lm(mpg ~ wt, data=cs.dt)
fit <- lm(mpg ~ ., data=cs.dt)
summary(fit)
```

# The MPG difference between automatic and manual transmissions

```{r}
wt.max <- max(cs.dt[am==1, wt])
wt.min <- min(cs.dt[am==0, wt])
wt.min
cs.dt.res <- cs.dt[wt>=wt.min & wt<=wt.max]
ggplot(cs.dt.res, aes(wt, mpg, colour=am)) +
    geom_point() +
        theme_tufte() +
            geom_smooth(method='lm')

ggplot(cs.dt.res, aes(am, mpg, colour=am)) +
    geom_boxplot() +
        theme_tufte() 


```

## Appendix

```{r, fig.width = 12, fig.height=10, fig.fullwidth = TRUE, fig.cap = "Full width figure"}

pairs(cs.dt[,.(mpg,cyl, disp, hp, drat, wt, qsec, vs, am, gear, carb)], panel = panel.smooth)
```

This style provides a- and b-heads (that is, `#` and `##`),
demonstrated above.  An error is emitted if you try to use `###` and
smaller headings.

\newthought{In his later books}[^books_be], Tufte starts each section
with a bit of vertical space, a non-indented paragraph, and sets the
first few words of the sentence in small caps. To accomplish this
using this style, use the `\newthought` command as demonstrated at the
beginning of this paragraph.

# Figures

## Margin Figures

Images and graphics play an integral role in Tufte's work. To place figures or tables in the margin you can use the `fig.margin` knitr chunk option. For example:

```{r, fig.margin = TRUE, fig.cap = "Sepal length vs. petal length, colored by species"}
library(ggplot2)
qplot(Sepal.Length, Petal.Length, data = iris, color = Species)
```

Note the use of the `fig.cap` chunk option to provide a figure caption. You can adjust the proportions of figures using the `fig.width` and `fig.height` chunk options. These are specified in inches, and will be automatically scaled down to fit within the handout margin.

## Equations

You can also include \LaTeX\ equations in the margin by explicitly invoking the `marginfigure` environment.

\begin{marginfigure}
$$\frac{d}{dx}\left( \int_{0}^{x} f(u)\,du\right)=f(x).$$
\caption{An equation}
\end{marginfigure}

Note the use of the `\caption` command to add additional text below the equation.

## Full Width Figures

You can arrange for figures to span across the entire page by using the `fig.fullwidth` chunk option. 

```{r, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "Full width figure"}
qplot(wt, mpg, data=mtcars, colour=factor(cyl))
```

Note the use of the `fig.width` and `fig.height` chunk options to establish the proportions of the figure. Full width figures look much better if their height is minimized.

## Main Column Figures

Besides margin and full width figures, you can of course also include figures constrained to the main column.

```{r, fig.cap = "Another figure"}
qplot(factor(cyl), mpg, data = mtcars, geom = "boxplot")
```

# Sidenotes

One of the most prominent and distinctive features of this style is the extensive use of sidenotes. There is a wide margin to provide ample room for sidenotes and small figures. Any use of a footnote will automatically be converted to a sidenote. ^[This is a sidenote that was entered using a footnote.] 

If you'd like to place ancillary information in the margin without the sidenote mark (the superscript number), you can use the `\marginnote` command. \marginnote{This is a margin note.  Notice that there isn't a number preceding the note.}

Note also that the two footnote references (`tufte_latex` and `books_be`, both defined below) were also included in the margin on the first page of this document.

# Tables

You can use the **xtable** package to format \LaTeX\ tables that integrate well with the rest of the Tufte handout style. Note that it's important to set the `xtable.comment` and `xtable.booktabs` options as shown below to ensure the table is formatted correctly for inclusion in the document.

```{r, results='asis'}
library(xtable)
options(xtable.comment = FALSE)
options(xtable.booktabs = TRUE)
xtable(head(mtcars[,1:6]), caption = "First rows of mtcars")
```


[^tufte_latex]: https://code.google.com/p/tufte-latex/
[^books_be]: http://www.edwardtufte.com/tufte/books_be










